# Incidex 実装ロードマップ

## プロジェクトの位置づけ

**セルフホスティング型OSSインシデント管理ツール**

- 各企業が社内でデプロイして利用
- マルチテナンシーは不要（1企業1デプロイ）
- 社内メンバーのみが利用

## 現在の実装状況（✅ 完了）

### コア機能
- ✅ インシデント管理（CRUD、フィルタ、検索、ソート）
- ✅ 認証・認可（JWT、ロールベース: admin/editor/viewer）
- ✅ SLA管理（重要度別の自動設定、違反判定）
- ✅ AI要約生成（OpenAI連携）
- ✅ ポストモーテム機能
- ✅ アクションアイテム管理
- ✅ アクティビティログ（インシデント操作履歴）
- ✅ 監査ログ（システム全体の操作記録）
- ✅ 添付ファイル管理（MinIO）
- ✅ タイムラインイベント管理
- ✅ 担当者割り当て機能
- ✅ タグ管理

### インフラ
- ✅ Docker/Docker Compose対応
- ✅ PostgreSQL（データベース）
- ✅ Redis（キャッシング）
- ✅ MinIO（オブジェクトストレージ）

### 通知基盤
- ✅ 通知サービス実装（バックエンド）
  - インシデント作成
  - ステータス変更
  - 担当者割り当て
  - 解決通知
  - ※実際の送信は未実装（現在はログ出力のみ）

## クリティカル機能（優先実装）

### 🔴 Priority 1: ユーザー管理UI

**目的**: 管理者がUIからユーザーを管理できるようにする

**現状の課題**:
- ユーザーは自分でサインアップ可能
- 管理者がユーザーを作成/編集/削除する手段がない
- ロール変更ができない
- ユーザーの無効化ができない

**実装内容**:
- [ ] バックエンド
  - [ ] ユーザー一覧取得API（既存）
  - [ ] ユーザー作成API（管理者のみ）
  - [ ] ユーザー更新API（管理者のみ、ロール変更含む）
  - [ ] ユーザー削除API（管理者のみ）
  - [ ] ユーザー無効化/有効化機能（論理削除）
  - [ ] パーミッションチェック強化

- [ ] フロントエンド
  - [ ] `/users` ページ改善（管理者専用）
    - [ ] ユーザー一覧表示（既存）
    - [ ] ユーザー作成フォーム
    - [ ] ユーザー編集モーダル
    - [ ] ユーザー削除機能
    - [ ] ロール変更機能
    - [ ] ステータス（有効/無効）表示・変更

**技術仕様**:
- Domain: `User`エンティティに`is_active`フィールド追加
- Middleware: 無効化ユーザーのログイン拒否
- Permission: Admin権限チェック

**見積もり時間**: 2-3時間

---

### 🔴 Priority 2: 初期管理者セットアップ

**目的**: 初回起動時に管理者アカウントを自動作成

**現状の課題**:
- 初回デプロイ時、誰かが手動でサインアップする必要がある
- 最初のユーザーがviewerロールになる可能性

**実装内容**:
- [ ] 環境変数で初期管理者を設定
  - `INITIAL_ADMIN_EMAIL`
  - `INITIAL_ADMIN_PASSWORD`
  - `INITIAL_ADMIN_NAME`
- [ ] サーバー起動時にチェック
  - ユーザーが0人なら初期管理者を作成
  - すでにユーザーがいればスキップ
- [ ] ドキュメント更新（README, docker-compose.yml）

**技術仕様**:
- `cmd/server/main.go`に初期化ロジック追加
- seedデータとは別の仕組み（本番用）

**見積もり時間**: 30分

---

### 🔴 Priority 3: パスワードリセット機能

**目的**: 管理者がUIからユーザーのパスワードをリセット可能にする

**現状の課題**:
- パスワードを忘れたらDB直接操作が必要
- セキュリティリスク

**実装オプション**:

#### オプションA: 管理者経由のリセット（推奨）
メール送信不要、シンプル

- [ ] バックエンド
  - [ ] `POST /api/users/:id/reset-password` (Admin専用)
  - [ ] 新しいパスワードを生成して返す（または管理者が指定）
  - [ ] 通知サービス経由でユーザーに通知（将来的に）

- [ ] フロントエンド
  - [ ] ユーザー管理UIに「パスワードリセット」ボタン
  - [ ] 新しいパスワードを表示（コピー可能）

#### オプションB: メール経由のリセット
より本格的だが、メール設定が必要

- [ ] パスワードリセットトークン管理
- [ ] メール送信実装が前提

**推奨**: まずオプションAを実装、将来的にオプションBを追加

**見積もり時間**: 1時間（オプションA）

---

### 🟡 Priority 4: ヘルスチェックエンドポイント

**目的**: 監視ツール、オーケストレーションツールとの連携

**実装内容**:
- [ ] `GET /health` エンドポイント
  - DB接続チェック
  - Redis接続チェック
  - MinIO接続チェック
  - ステータス: `healthy` / `degraded` / `unhealthy`

- [ ] `GET /ready` エンドポイント
  - サービスが準備完了かチェック

- [ ] `GET /version` エンドポイント
  - バージョン情報

**技術仕様**:
- 認証不要（publicエンドポイント）
- Kubernetes liveness/readiness probeで利用可能

**見積もり時間**: 15-30分

---

### 🟡 Priority 5: 実際の通知実装

**目的**: SLA違反、インシデント更新等を実際に通知

**現状**: 通知サービスは実装済みだが、ログ出力のみ

**実装内容**:
- [ ] 通知設定UI（`/settings/notifications`改善）
  - [ ] 通知チャンネル選択（Email/Slack/Webhook）
  - [ ] 各チャンネルの設定（SMTP、Slack URL等）
  - [ ] 通知種類ごとのON/OFF

- [ ] Email送信実装
  - [ ] SMTP設定（環境変数）
  - [ ] テンプレート作成
  - [ ] 送信ロジック

- [ ] Slack送信実装
  - [ ] Webhook URL設定
  - [ ] フォーマット整形
  - [ ] 送信ロジック

- [ ] Webhook送信実装
  - [ ] カスタムWebhook URL
  - [ ] ペイロード標準化

- [ ] SLA違反アラート実装
  - [ ] 定期チェック（cron or ticker）
  - [ ] SLA期限が近いインシデントを通知

**技術仕様**:
- `internal/infrastructure/notification/`を拡張
- 設定をDBに保存（新テーブル: `notification_settings`）
- 非同期送信（goroutine）

**見積もり時間**: 3-4時間

---

## Nice to Have（将来的な実装）

### 🟢 Priority 6: 設定管理UI

- SLA設定（重要度別の時間設定）
- システム設定（リテンション期間等）

### 🟢 Priority 7: データエクスポート

- CSV/JSONエクスポート
- 期間指定
- フィルタ適用

### 🟢 Priority 8: LDAP/SAML連携

- 大企業向けSSO
- Active Directory連携

### 🟢 Priority 9: API ドキュメント

- Swagger/OpenAPI自動生成
- `/api/docs` エンドポイント

### 🟢 Priority 10: メトリクス・監視

- Prometheus metrics エンドポイント
- パフォーマンスメトリクス

---

## 実装方針

### 開発フロー
1. 機能ごとにバックエンド→フロントエンドの順で実装
2. 各実装後にビルド確認
3. Clean Architectureを維持
4. 既存コードパターンに従う

### ブランチ戦略
- `main`: 安定版
- 機能ごとに適宜ブランチ作成を検討

### テスト方針
- 実装と並行してテストコード追加を検討
- 重要なビジネスロジックから優先的に

---

## 完了条件

以下が揃ったら「セルフホスティング型OSSとして十分」と言える状態：

- ✅ Priority 1-3が完了
- ✅ ヘルスチェックが実装済み
- ✅ README/ドキュメントが整備済み
- ✅ 初回セットアップ手順が明確

通知機能（Priority 5）は「あると非常に良い」が、なくても運用可能。

---

## ドキュメント整備

### 必要なドキュメント
- [x] CLAUDE.md（開発ガイド）- 既存
- [x] ROADMAP.md（本ドキュメント）- 作成完了
- [ ] README.md（更新）
  - [ ] 初期セットアップ手順
  - [ ] 環境変数一覧
  - [ ] トラブルシューティング
- [ ] CONTRIBUTING.md（コントリビューションガイド）
- [ ] DEPLOYMENT.md（デプロイ手順）

---

最終更新: 2025-12-23
