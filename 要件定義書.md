# incidex 要件定義書

## 1. 機能要件

### 1.1 認証・ユーザー管理

| ID | 要件 | 優先度 |
|----|------|--------|
| AUTH-01 | ユーザーはメールアドレスとパスワードで新規登録できる | 必須 |
| AUTH-02 | ユーザーはメールアドレスとパスワードでログインできる | 必須 |
| AUTH-03 | ログイン後、JWTトークンが発行される（有効期限24時間） | 必須 |
| AUTH-04 | ユーザーは役割を持つ（管理者/編集者/閲覧者） | 必須 |
| AUTH-05 | 閲覧者は参照のみ、編集者は作成・編集、管理者は全権限 | 必須 |
| AUTH-06 | パスワードはハッシュ化して保存する | 必須 |

### 1.2 インシデント管理

| ID | 要件 | 優先度 |
|----|------|--------|
| INC-01 | ユーザーは新規インシデントを作成できる | 必須 |
| INC-02 | インシデントには以下の項目を持つ：タイトル、詳細説明、深刻度、ステータス、影響範囲、検知日時、解決日時、担当者 | 必須 |
| INC-03 | 深刻度は4段階（Critical/High/Medium/Low） | 必須 |
| INC-04 | ステータスは4段階（Open/Investigating/Resolved/Closed） | 必須 |
| INC-05 | ユーザーはインシデント一覧を閲覧できる（ページネーション付き、1ページ20件） | 必須 |
| INC-06 | ユーザーはインシデント詳細を閲覧できる | 必須 |
| INC-07 | 編集権限を持つユーザーはインシデントを編集できる | 必須 |
| INC-08 | 管理者はインシデントを削除できる | 必須 |
| INC-09 | タイトルまたは説明で部分一致検索できる | 必須 |
| INC-10 | 深刻度、ステータス、タグでフィルタリングできる | 必須 |

### 1.3 AI要約機能

| ID | 要件 | 優先度 |
|----|------|--------|
| AI-01 | インシデント作成時、詳細説明から自動で要約を生成する | 必須 |
| AI-02 | ユーザーは要約を手動で再生成できる | 必須 |
| AI-03 | Claude API または OpenAI API を使用する | 必須 |
| AI-04 | API呼び出しが失敗した場合、エラーメッセージを表示し要約なしで保存できる | 必須 |
| AI-05 | 要約は300文字以内とする | 必須 |
| AI-06 | 生成された要約はRedisにキャッシュする（削除または再生成まで永続） | 推奨 |

### 1.4 タイムライン機能

| ID | 要件 | 優先度 |
|----|------|--------|
| TL-01 | インシデントにタイムラインイベントを追加できる | 必須 |
| TL-02 | イベントには以下の項目を持つ：イベント時刻、イベントタイプ、説明、記録者 | 必須 |
| TL-03 | イベントタイプは以下から選択：検知/調査開始/原因特定/緩和/解決/その他 | 必須 |
| TL-04 | タイムラインは時系列順（古い順）に表示される | 必須 |
| TL-05 | ユーザーはイベントを編集・削除できる | 必須 |

### 1.5 タグ管理

| ID | 要件 | 優先度 |
|----|------|--------|
| TAG-01 | 管理者はタグを作成できる | 必須 |
| TAG-02 | タグには名前とカラー（Hex形式）を設定できる | 必須 |
| TAG-03 | インシデントに複数のタグを付与できる | 必須 |
| TAG-04 | タグでインシデントをフィルタリングできる | 必須 |
| TAG-05 | 管理者はタグを編集・削除できる | 必須 |

### 1.6 ダッシュボード

| ID | 要件 | 優先度 |
|----|------|--------|
| DASH-01 | インシデント総件数を表示する | 必須 |
| DASH-02 | 期間別のインシデント件数推移を折れ線グラフで表示する（日別/週別/月別切替） | 必須 |
| DASH-03 | 深刻度別の分布を円グラフで表示する | 必須 |
| DASH-04 | ステータス別の分布を円グラフで表示する | 必須 |
| DASH-05 | 最近のインシデント一覧（直近10件）を表示する | 必須 |
| DASH-06 | ダッシュボード統計はRedisに5分間キャッシュする | 推奨 |

### 1.7 ポストモーテム（Phase 2）

| ID | 要件 | 優先度 |
|----|------|--------|
| PM-01 | 解決済みインシデントにポストモーテムを作成できる | Phase 2 |
| PM-02 | ポストモーテムには以下を含む：根本原因、良かった点、改善点、再発防止策、アクションアイテム | Phase 2 |
| PM-03 | アクションアイテムには担当者と期限を設定できる | Phase 2 |
| PM-04 | AIによる根本原因分析の提案機能 | Phase 2 |

### 1.8 高度な検索（Phase 2）

| ID | 要件 | 優先度 |
|----|------|--------|
| SEARCH-01 | PostgreSQL全文検索でタイトル・説明を検索できる | Phase 2 |
| SEARCH-02 | 複数条件（深刻度、ステータス、タグ、日付範囲、担当者）で絞り込める | Phase 2 |
| SEARCH-03 | 検索結果はRedisに3分間キャッシュする | Phase 2 |

### 1.9 統計・分析（Phase 2）

| ID | 要件 | 優先度 |
|----|------|--------|
| STAT-01 | MTTR（平均復旧時間）を計算・表示する | Phase 2 |
| STAT-02 | タグ別のインシデント件数を表示する | Phase 2 |
| STAT-03 | 月次・四半期のサマリーレポートを表示する | Phase 2 |

### 1.10 PDF生成（Phase 3）

| ID | 要件 | 優先度 |
|----|------|--------|
| PDF-01 | 単体インシデントのPDFレポートを出力できる | Phase 3 |
| PDF-02 | 期間指定でサマリーレポートをPDF出力できる | Phase 3 |
| PDF-03 | PDFには統計グラフを含む | Phase 3 |

### 1.11 ファイル添付（Phase 3）

| ID | 要件 | 優先度 |
|----|------|--------|
| FILE-01 | インシデントにファイルを添付できる（最大50MB/ファイル） | Phase 3 |
| FILE-02 | ファイルはMinIOに保存する | Phase 3 |
| FILE-03 | 画像ファイルはプレビュー表示できる | Phase 3 |

---

## 2. 非機能要件

### 2.1 パフォーマンス

| ID | 要件 | 目標値 |
|----|------|--------|
| PERF-01 | API応答時間（95パーセンタイル） | < 500ms |
| PERF-02 | AI要約生成時間 | < 5秒 |
| PERF-03 | ダッシュボード表示時間 | < 1秒 |
| PERF-04 | 同時接続ユーザー数 | 50名まで対応 |

### 2.2 セキュリティ

| ID | 要件 |
|----|------|
| SEC-01 | パスワードはbcryptでハッシュ化する（コスト10以上） |
| SEC-02 | SQLインジェクション対策（ORMのプレースホルダ使用） |
| SEC-03 | XSS対策（React自動エスケープ + CSPヘッダー） |
| SEC-04 | CSRF対策（JWTトークン検証） |
| SEC-05 | HTTPS通信を推奨（本番環境） |
| SEC-06 | APIリクエストにはJWTトークン必須（認証エンドポイント除く） |

### 2.3 可用性・信頼性

| ID | 要件 |
|----|------|
| AVAIL-01 | データベースは定期的にバックアップ可能な構成とする |
| AVAIL-02 | Redis障害時もシステムは動作する（キャッシュなしで） |
| AVAIL-03 | AI API障害時もインシデント登録は可能（要約なし） |

### 2.4 保守性

| ID | 要件 |
|----|------|
| MAINT-01 | ログは構造化ログ（JSON形式）で出力する |
| MAINT-02 | エラーログには適切なスタックトレースを含む |
| MAINT-03 | Docker Composeで全サービスを管理できる |

### 2.5 互換性

| ID | 要件 |
|----|------|
| COMPAT-01 | ブラウザ：Chrome/Firefox/Safari/Edge 最新2バージョン |
| COMPAT-02 | 画面サイズ：1280x720以上を推奨 |
| COMPAT-03 | レスポンシブ対応（タブレット・スマホでも閲覧可能） |

---

## 3. データ要件

### 3.1 保存期間

| データ種別 | 保存期間 |
|-----------|---------|
| インシデント | 無期限（ユーザーが削除するまで） |
| タイムラインイベント | インシデントに紐づき永続 |
| ポストモーテム | インシデントに紐づき永続 |
| ファイル | インシデント削除時に削除 |
| ユーザーアカウント | アカウント削除まで |

### 3.2 データ容量見積もり

| 項目 | 想定値 |
|------|--------|
| インシデント数 | 最大10,000件/年 |
| 1インシデントあたりのサイズ | 平均10KB（要約・詳細含む） |
| ファイル総容量 | 最大100GB（Phase 3） |
| データベース容量 | 初年度500MB程度 |

---

## 4. インターフェース要件

### 4.1 API設計

- REST API形式
- JSON形式でのデータ交換
- 認証：Bearer Token（JWT）
- エンドポイント例：
  - `POST /api/auth/login` - ログイン
  - `GET /api/incidents` - インシデント一覧
  - `POST /api/incidents` - インシデント作成
  - `GET /api/incidents/:id` - インシデント詳細
  - `POST /api/incidents/:id/summarize` - AI要約生成
  - `POST /api/incidents/:id/timeline` - タイムライン追加

### 4.2 画面構成

| 画面 | 説明 |
|------|------|
| ログイン画面 | メールアドレス・パスワード入力 |
| ダッシュボード | 統計情報・グラフ表示 |
| インシデント一覧 | テーブル形式、検索・フィルタ機能 |
| インシデント詳細 | 基本情報・タイムライン・ポストモーテム表示 |
| インシデント作成/編集 | フォーム形式、バリデーション付き |
| タグ管理 | タグ一覧・作成・編集 |

---

## 5. 制約事項

| 項目 | 制約 |
|------|------|
| 対応言語 | 英語のみ（Phase 1）、日本語は将来対応 |
| AI API | Claude または OpenAI のみ対応 |
| ファイル形式 | 一般的な画像・ログファイル（実行ファイル不可） |
| ブラウザ | IE非対応 |
| デプロイ | セルフホストのみ、SaaS版なし |

---

## 6. 前提条件

- Docker / Docker Compose が利用可能な環境
- PostgreSQL 15+, Redis 7+, MinIO がDockerで起動可能
- Claude API または OpenAI API のキーを取得済み
- インターネット接続可能（AI API呼び出しのため）